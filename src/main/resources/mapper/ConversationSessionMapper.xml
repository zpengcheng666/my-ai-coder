<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.ai.mapper.ConversationSessionMapper">

    <select id="selectByConversationId" resultType="org.example.ai.entity.ConversationSession">
        SELECT * FROM conversation_session 
        WHERE conversation_id = #{conversationId}
    </select>

    <select id="selectByUserIdAndStatusOrderByLastActiveTimeDesc" resultType="org.example.ai.entity.ConversationSession">
        SELECT * FROM conversation_session 
        WHERE user_id = #{userId} AND status = #{status} 
        ORDER BY last_active_time DESC
    </select>

    <update id="updateSessionActivity">
        UPDATE conversation_session 
        SET last_active_time = #{lastActiveTime}, 
            message_count = message_count + 1, 
            total_tokens = total_tokens + #{tokenUsed} 
        WHERE conversation_id = #{conversationId}
    </update>

    <select id="selectSessionsToArchive" resultType="org.example.ai.entity.ConversationSession">
        SELECT * FROM conversation_session 
        WHERE status = 'ACTIVE' AND last_active_time &lt; #{archiveTime}
    </select>

    <update id="softDeleteByConversationIdAndUserId">
        UPDATE conversation_session 
        SET status = 'DELETED', update_time = NOW() 
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </update>

</mapper>